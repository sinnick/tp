<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a8cd8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üßµ</text></svg>">
    <title>Thread Pocket üßµ</title>
    <style>
        :root {
            --bg: #faf9f7;
            --text: #2d2d2d;
            --text-muted: #6b6b6b;
            --accent: #1a8cd8;
            --border: #e5e5e5;
            --card-bg: #ffffff;
        }
        
        [data-theme="dark"] {
            --bg: #1a1a1a;
            --text: #e5e5e5;
            --text-muted: #999;
            --accent: #4aa3e0;
            --border: #333;
            --card-bg: #242424;
        }
        
        [data-theme="sepia"] {
            --bg: #f4ecd8;
            --text: #433422;
            --text-muted: #7a6a5a;
            --accent: #8b4513;
            --border: #d4c4a8;
            --card-bg: #faf6eb;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            line-height: 1.8;
            transition: all 0.3s ease;
        }
        
        .sticky-header {
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 100;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }
        
        .header-inner {
            max-width: 680px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
            min-width: 0;
        }
        
        .back-btn {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            padding: 0.4rem;
            font-size: 1.2rem;
            display: none;
            flex-shrink: 0;
        }
        
        .back-btn:hover {
            opacity: 0.7;
        }
        
        .back-btn.visible {
            display: block;
        }
        
        .header-title {
            font-size: 1.2rem;
            margin: 0;
            font-weight: normal;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .container {
            max-width: 680px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        .controls {
            display: flex;
            gap: 0.3rem;
            flex-shrink: 0;
        }
        
        .theme-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 0.4rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text);
            transition: all 0.2s;
        }
        
        .theme-btn:hover {
            border-color: var(--accent);
        }

        /* Sync status bar */
        .sync-bar {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.8rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sync-icon {
            font-size: 1.1rem;
        }
        
        .sync-icon.syncing {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .sync-text {
            color: var(--text-muted);
        }
        
        .last-sync {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        /* Offline banner */
        .offline-banner {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .offline-banner h3 {
            margin: 0 0 0.3rem;
            font-size: 1rem;
        }
        
        .offline-banner p {
            margin: 0;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .thread-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .thread-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .thread-item:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
        }
        
        .thread-item h3 {
            margin: 0 0 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .thread-item .meta {
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .thread-item-cover {
            width: 100%;
            height: 140px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 0.8rem;
        }
        
        /* Reader view */
        .reader {
            display: none;
        }
        
        .reader.active {
            display: block;
        }
        
        .reader-content {
            font-size: 1.15rem;
        }
        
        .reader-content p {
            margin-bottom: 1.5rem;
        }
        
        .reader-content hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 2rem 0;
        }
        
        .reader-content a {
            color: var(--accent);
        }
        
        .reader-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1.5rem 0;
            display: block;
        }
        
        .reader-content img:first-of-type {
            max-height: 300px;
            object-fit: cover;
            width: 100%;
        }
        
        .tweet-block {
            background: var(--card-bg);
            border-left: 3px solid var(--accent);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
        }
        
        .tweet-author {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .tweet-handle {
            color: var(--text-muted);
            font-weight: normal;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }
        
        .empty-state p {
            margin: 0.5rem 0;
        }
        
        code {
            background: var(--border);
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .save-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .url-input {
            flex: 1;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            background: var(--card-bg);
            color: var(--text);
        }
        
        .url-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .save-btn {
            padding: 0.8rem 1.5rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: opacity 0.2s;
        }
        
        .save-btn:hover {
            opacity: 0.9;
        }
        
        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status-msg {
            padding: 0.8rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .status-msg.success {
            display: block;
            background: #d4edda;
            color: #155724;
        }
        
        .status-msg.error {
            display: block;
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-msg.loading {
            display: block;
            background: var(--card-bg);
            color: var(--text-muted);
        }

        [data-theme="dark"] .status-msg.success {
            background: #1e3a2f;
            color: #75d99a;
        }
        
        [data-theme="dark"] .status-msg.error {
            background: #3a1e1e;
            color: #e57373;
        }

        .delete-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.2rem 0.5rem;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .thread-item:hover .delete-btn {
            opacity: 1;
        }
        
        .delete-btn:hover {
            color: #dc3545;
        }
        
        .thread-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        /* Article count badge */
        .article-count {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }
        
        /* Mobile adjustments */
        @media (max-width: 600px) {
            .reader-content h1 {
                font-size: 1.5rem;
                line-height: 1.3;
            }
            
            .reader-content h2 {
                font-size: 1.25rem;
            }
            
            .reader-content {
                font-size: 1rem;
            }
            
            .header-title {
                font-size: 0.95rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .sync-bar {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body data-theme="light">
    <header class="sticky-header">
        <div class="header-inner">
            <div class="header-left">
                <button class="back-btn" id="back-btn" onclick="showList()">‚Üê</button>
                <h1 class="header-title" id="header-title">üßµ Thread Pocket</h1>
            </div>
            <div class="controls">
                <button class="theme-btn" onclick="setTheme('light')">‚òÄÔ∏è</button>
                <button class="theme-btn" onclick="setTheme('sepia')">üìú</button>
                <button class="theme-btn" onclick="setTheme('dark')">üåô</button>
            </div>
        </div>
    </header>

    <div class="container">
        <main id="list-view">
            <!-- Offline banner (hidden when online) -->
            <div class="offline-banner" id="offline-banner" style="display: none;">
                <h3>üì¥ Modo lectura</h3>
                <p>Conectate a internet para agregar art√≠culos</p>
            </div>

            <!-- Online: sync bar + form -->
            <div id="online-controls">
                <div class="sync-bar" id="sync-bar">
                    <div class="sync-status">
                        <span class="sync-icon" id="sync-icon">‚úì</span>
                        <span class="sync-text" id="sync-text">Sincronizado</span>
                    </div>
                    <span class="last-sync" id="last-sync"></span>
                </div>
                
                <div class="save-form">
                    <input type="text" id="url-input" placeholder="Pegar URL de Twitter/X..." class="url-input">
                    <button class="save-btn" onclick="saveThread()">Guardar</button>
                </div>
            </div>
            
            <div id="status-msg" class="status-msg"></div>
            
            <div class="article-count" id="article-count"></div>
            
            <ul class="thread-list" id="thread-list">
                <!-- Threads will be listed here -->
            </ul>
            
            <div class="empty-state" id="empty-state" style="display: none;">
                <p>No hay art√≠culos guardados.</p>
                <p>Peg√° una URL de Twitter/X para empezar.</p>
            </div>
        </main>
        
        <div class="reader" id="reader-view">
            <div class="reader-content" id="reader-content">
                <!-- Thread content here -->
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const API_BASE = '/tp/api';
        const CACHE_KEY = 'thread-pocket-threads';
        const SYNC_KEY = 'thread-pocket-last-sync';
        let threads = [];
        let isOffline = !navigator.onLine;
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('[SW] Registered'))
                .catch(err => console.error('[SW] Registration failed:', err));
        }
        
        // Offline detection
        window.addEventListener('online', () => {
            isOffline = false;
            updateOfflineUI();
            syncThreads();
        });
        
        window.addEventListener('offline', () => {
            isOffline = true;
            updateOfflineUI();
        });
        
        // Update UI based on online/offline status
        function updateOfflineUI() {
            const offlineBanner = document.getElementById('offline-banner');
            const onlineControls = document.getElementById('online-controls');
            
            if (isOffline) {
                offlineBanner.style.display = 'block';
                onlineControls.style.display = 'none';
            } else {
                offlineBanner.style.display = 'none';
                onlineControls.style.display = 'block';
            }
        }
        
        // Theme management
        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('thread-pocket-theme', theme);
        }
        
        // Load saved theme
        const savedTheme = localStorage.getItem('thread-pocket-theme') || 'light';
        setTheme(savedTheme);
        
        // Sync status UI
        function setSyncStatus(status) {
            const icon = document.getElementById('sync-icon');
            const text = document.getElementById('sync-text');
            const lastSync = document.getElementById('last-sync');
            
            switch(status) {
                case 'syncing':
                    icon.textContent = 'üîÑ';
                    icon.classList.add('syncing');
                    text.textContent = 'Sincronizando...';
                    break;
                case 'success':
                    icon.textContent = '‚úì';
                    icon.classList.remove('syncing');
                    text.textContent = 'Sincronizado';
                    // Save sync timestamp
                    const now = Date.now();
                    localStorage.setItem(SYNC_KEY, now);
                    updateLastSyncDisplay();
                    break;
                case 'error':
                    icon.textContent = '‚ö†Ô∏è';
                    icon.classList.remove('syncing');
                    text.textContent = 'Error al sincronizar';
                    break;
                case 'cached':
                    icon.textContent = 'üì¶';
                    icon.classList.remove('syncing');
                    text.textContent = 'Desde cach√©';
                    break;
            }
        }
        
        function updateLastSyncDisplay() {
            const lastSyncEl = document.getElementById('last-sync');
            const lastSyncTime = localStorage.getItem(SYNC_KEY);
            
            if (lastSyncTime) {
                const date = new Date(parseInt(lastSyncTime));
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                
                let timeAgo;
                if (diffMins < 1) {
                    timeAgo = 'ahora';
                } else if (diffMins < 60) {
                    timeAgo = `hace ${diffMins}m`;
                } else if (diffHours < 24) {
                    timeAgo = `hace ${diffHours}h`;
                } else {
                    timeAgo = date.toLocaleDateString();
                }
                
                lastSyncEl.textContent = timeAgo;
            }
        }
        
        // Status message
        function showStatus(msg, type) {
            const el = document.getElementById('status-msg');
            el.textContent = msg;
            el.className = 'status-msg ' + type;
            if (type !== 'loading') {
                setTimeout(() => el.className = 'status-msg', 3000);
            }
        }
        
        // Sync threads from server
        async function syncThreads() {
            if (isOffline) {
                loadFromCache();
                return;
            }
            
            setSyncStatus('syncing');
            
            try {
                const res = await fetch(API_BASE + '/threads');
                if (!res.ok) throw new Error('Server error');
                
                threads = await res.json();
                
                // Cache everything (including full content)
                localStorage.setItem(CACHE_KEY, JSON.stringify(threads));
                
                setSyncStatus('success');
                renderList();
                
                console.log(`[Sync] Cached ${threads.length} articles with full content`);
            } catch (err) {
                console.error('Sync failed:', err);
                setSyncStatus('error');
                
                // Fall back to cache
                loadFromCache();
            }
        }
        
        // Load from cache (offline mode)
        function loadFromCache() {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                threads = JSON.parse(cached);
                renderList();
                if (!isOffline) {
                    setSyncStatus('cached');
                }
                console.log(`[Cache] Loaded ${threads.length} articles`);
            }
            updateLastSyncDisplay();
        }
        
        // Save thread from URL
        async function saveThread() {
            if (isOffline) {
                showStatus('Necesit√°s conexi√≥n para guardar', 'error');
                return;
            }
            
            const input = document.getElementById('url-input');
            const btn = document.querySelector('.save-btn');
            const url = input.value.trim();
            
            if (!url) {
                showStatus('Peg√° una URL de Twitter/X', 'error');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Guardando...';
            showStatus('Obteniendo thread...', 'loading');
            
            try {
                const res = await fetch(API_BASE + '/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Error al guardar');
                }
                
                showStatus(`‚úÖ Guardado: ${data.tweetCount} tweets de @${data.author}`, 'success');
                input.value = '';
                
                // Re-sync to get the new article
                syncThreads();
            } catch (err) {
                showStatus('‚ùå ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Guardar';
            }
        }
        
        // Delete thread
        async function deleteThread(filename, e) {
            e.stopPropagation();
            if (isOffline) {
                showStatus('Necesit√°s conexi√≥n para eliminar', 'error');
                return;
            }
            if (!confirm('¬øEliminar este art√≠culo?')) return;
            
            try {
                await fetch(API_BASE + '/threads/' + encodeURIComponent(filename), {
                    method: 'DELETE'
                });
                syncThreads();
            } catch (err) {
                showStatus('‚ùå Error al eliminar', 'error');
            }
        }
        
        // Render thread list
        function renderList() {
            const list = document.getElementById('thread-list');
            const empty = document.getElementById('empty-state');
            const countEl = document.getElementById('article-count');
            
            if (threads.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                countEl.textContent = '';
                return;
            }
            
            empty.style.display = 'none';
            countEl.textContent = `${threads.length} art√≠culo${threads.length !== 1 ? 's' : ''} guardado${threads.length !== 1 ? 's' : ''}`;
            
            list.innerHTML = threads.map((t, i) => `
                <li class="thread-item" onclick="showReader(${i})">
                    ${t.cover_image ? `<img src="${t.cover_image}" class="thread-item-cover" alt="Cover" loading="lazy">` : ''}
                    <div class="thread-item-header">
                        <h3>${escapeHtml(t.title || `Thread de ${t.author || 'Unknown'}`)}</h3>
                        ${!isOffline ? `<button class="delete-btn" onclick="deleteThread('${t.filename}', event)">üóëÔ∏è</button>` : ''}
                    </div>
                    <div class="meta">
                        ${escapeHtml(t.author_name || '')} ¬∑ 
                        ${t.saved_at ? new Date(t.saved_at).toLocaleDateString() : 'Sin fecha'}
                    </div>
                </li>
            `).join('');
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Show reader view
        function showReader(index) {
            const thread = threads[index];
            if (!thread || !thread.content) {
                showStatus('Contenido no disponible', 'error');
                return;
            }
            
            document.getElementById('list-view').style.display = 'none';
            document.getElementById('reader-view').classList.add('active');
            document.getElementById('reader-content').innerHTML = marked.parse(thread.content);
            
            // Update header
            document.getElementById('back-btn').classList.add('visible');
            const title = thread.title || `Thread de ${thread.author || 'Unknown'}`;
            document.getElementById('header-title').textContent = title;
            
            window.scrollTo(0, 0);
        }
        
        // Show list view
        function showList() {
            document.getElementById('list-view').style.display = 'block';
            document.getElementById('reader-view').classList.remove('active');
            
            document.getElementById('back-btn').classList.remove('visible');
            document.getElementById('header-title').textContent = 'üßµ Thread Pocket';
            
            window.scrollTo(0, 0);
        }
        
        // Enter key to save
        document.getElementById('url-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') saveThread();
        });
        
        // Initial load
        updateOfflineUI();
        updateLastSyncDisplay();
        
        if (isOffline) {
            loadFromCache();
        } else {
            syncThreads();
        }
    </script>
</body>
</html>
