<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a8cd8">
    <title>Saving... | Thread Pocket</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #faf9f7;
            color: #2d2d2d;
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .status {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }
        
        .detail {
            color: #6b6b6b;
            font-size: 0.9rem;
            max-width: 300px;
            word-break: break-all;
        }
        
        .error {
            color: #dc3545;
        }
        
        .success {
            color: #28a745;
        }
        
        .btn {
            margin-top: 1.5rem;
            padding: 0.8rem 2rem;
            background: #1a8cd8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e5e5;
            border-top-color: #1a8cd8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="content">
        <div class="spinner"></div>
        <div class="status">Saving thread...</div>
        <div class="detail" id="url-display"></div>
    </div>

    <script>
        const API_BASE = '/tp/api';
        
        async function handleShare() {
            const params = new URLSearchParams(window.location.search);
            let url = params.get('url') || params.get('text') || '';
            
            // Extract URL from text if needed (sometimes shared as "Title URL")
            const urlMatch = url.match(/https?:\/\/[^\s]+/);
            if (urlMatch) {
                url = urlMatch[0];
            }
            
            // Clean up URL
            url = url.trim();
            
            document.getElementById('url-display').textContent = url;
            
            // Validate it's a Twitter/X URL
            if (!url || (!url.includes('twitter.com') && !url.includes('x.com'))) {
                showError('Not a valid Twitter/X URL');
                return;
            }
            
            try {
                const res = await fetch(API_BASE + '/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Failed to save');
                }
                
                showSuccess(data);
            } catch (err) {
                showError(err.message);
            }
        }
        
        function showSuccess(data) {
            document.getElementById('content').innerHTML = `
                <div class="icon">✅</div>
                <div class="status success">Thread saved!</div>
                <div class="detail">${data.tweetCount} tweets from @${data.author}</div>
                <a href="/tp/" class="btn">Open Thread Pocket</a>
            `;
            
            // Auto-redirect after 2 seconds
            setTimeout(() => {
                window.location.href = '/tp/';
            }, 2000);
        }
        
        function showError(message) {
            document.getElementById('content').innerHTML = `
                <div class="icon">❌</div>
                <div class="status error">Failed to save</div>
                <div class="detail">${message}</div>
                <a href="/tp/" class="btn">Go to Thread Pocket</a>
            `;
        }
        
        // Start saving on page load
        handleShare();
    </script>
</body>
</html>
